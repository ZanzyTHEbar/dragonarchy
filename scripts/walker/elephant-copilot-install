#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DOTFILES_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

PROVIDER_REPO="${COPILOT_PROVIDER_REPO:-$HOME/Documents/elephant-copilot-provider}"
BUILD_DIR="$PROVIDER_REPO/build"
PLUGIN_PATH="$BUILD_DIR/copilot.so"
TARGET_DIR="$HOME/.config/elephant/providers"
TARGET_PATH="$TARGET_DIR/copilot.so"
CONFIG_DIR="$HOME/.config/elephant"
CONFIG_PATH="$CONFIG_DIR/copilot.toml"
GOAMD64_OVERRIDE="${COPILOT_GOAMD64:-}"
GOFLAGS_OVERRIDE="${COPILOT_GOFLAGS:-}"
ELEPHANT_VERSION_OVERRIDE="${COPILOT_ELEPHANT_VERSION:-}"
ELEPHANT_SRC_DIR="$PROVIDER_REPO/third_party/elephant"

if [[ ! -d "$PROVIDER_REPO" ]]; then
  printf 'Provider repo not found: %s\n' "$PROVIDER_REPO" >&2
  printf 'Set COPILOT_PROVIDER_REPO to override.\n' >&2
  exit 1
fi

if ! command -v go >/dev/null 2>&1; then
  printf 'Go toolchain not found. Install Go and retry.\n' >&2
  exit 1
fi

ensure_elephant_source() {
  if [[ -f "$ELEPHANT_SRC_DIR/go.mod" ]]; then
    return 0
  fi

  local version="$ELEPHANT_VERSION_OVERRIDE"
  if [[ -z "$version" ]] && command -v elephant >/dev/null 2>&1; then
    version="$(elephant version 2>/dev/null || true)"
  fi
  if [[ -z "$version" ]]; then
    version="2.19.1"
  fi

  local tarball="$HOME/.cache/paru/clone/elephant-all/v${version}.tar.gz"
  if [[ ! -f "$tarball" ]]; then
    printf 'Elephant source tarball not found: %s\n' "$tarball" >&2
    printf 'Build may fail due to plugin version mismatch.\n' >&2
    return 1
  fi

  mkdir -p "$PROVIDER_REPO/third_party/elephant"
  tar -xzf "$tarball" -C "$PROVIDER_REPO/third_party/elephant" --strip-components=1
}

ensure_elephant_source || true

detect_goamd64() {
  local detected=""

  if command -v elephant >/dev/null 2>&1; then
    detected="$(go version -m "$(command -v elephant)" 2>/dev/null | awk -F= '/GOAMD64=/{print $2; exit}')"
  fi

  if [[ -z "$detected" ]]; then
    detected="$(go env GOAMD64 2>/dev/null || true)"
  fi

  if [[ -z "$detected" ]]; then
    detected="v1"
  fi

  printf '%s' "$detected"
}

GOAMD64_VALUE="$GOAMD64_OVERRIDE"
if [[ -z "$GOAMD64_VALUE" ]]; then
  GOAMD64_VALUE="$(detect_goamd64)"
fi

GOFLAGS_VALUE="-trimpath -buildvcs=false"
if [[ -n "$GOFLAGS_OVERRIDE" ]]; then
  GOFLAGS_VALUE="$GOFLAGS_VALUE $GOFLAGS_OVERRIDE"
fi

build_from_elephant() {
  local source="$ELEPHANT_SRC_DIR"
  local provider_dir="$source/internal/providers/copilot"

  if [[ ! -f "$source/go.mod" ]]; then
    return 1
  fi

  mkdir -p "$provider_dir"
  cp -f "$PROVIDER_REPO/copilot.go" "$provider_dir/"
  cp -f "$PROVIDER_REPO/README.md" "$provider_dir/README.md"

  (
    cd "$source"
    GOFLAGS="$GOFLAGS_VALUE" go get github.com/ZanzyTHEbar/assert-lib@v1.3.1
    GOFLAGS="$GOFLAGS_VALUE" go get github.com/ZanzyTHEbar/errbuilder-go@v1.5.1
    GOFLAGS="$GOFLAGS_VALUE" go get github.com/google/uuid@v1.6.0
    GOFLAGS="$GOFLAGS_VALUE" go get github.com/sirupsen/logrus@v1.9.4
    GOFLAGS="$GOFLAGS_VALUE" go get github.com/spf13/viper@v1.21.0
    GOFLAGS="$GOFLAGS_VALUE" go mod tidy
  )

  printf 'Building copilot provider from Elephant source (GOAMD64=%s)\n' "$GOAMD64_VALUE"
  (
    cd "$provider_dir"
    GOAMD64="$GOAMD64_VALUE" GOFLAGS="$GOFLAGS_VALUE" go build -ldflags="-s -w" -buildvcs=false -buildmode=plugin -trimpath
  )

  mkdir -p "$BUILD_DIR"
  cp -f "$provider_dir/copilot.so" "$PLUGIN_PATH"
}

build_from_repo() {
  printf 'Building copilot provider from %s (GOAMD64=%s)\n' "$PROVIDER_REPO" "$GOAMD64_VALUE"
  mkdir -p "$BUILD_DIR"
  (
    cd "$PROVIDER_REPO"
    GOAMD64="$GOAMD64_VALUE" GOFLAGS="$GOFLAGS_VALUE" go build -ldflags="-s -w" -buildmode=plugin -o "$PLUGIN_PATH"
  )
}

if ! build_from_elephant; then
  printf 'Elephant source not available; falling back to repo build.\n' >&2
  build_from_repo
fi

mkdir -p "$TARGET_DIR"
cp -f "$PLUGIN_PATH" "$TARGET_PATH"
printf 'Installed provider -> %s\n' "$TARGET_PATH"

mkdir -p "$CONFIG_DIR"
if [[ -e "$CONFIG_PATH" ]]; then
  printf 'Config already exists: %s (leaving as-is)\n' "$CONFIG_PATH"
else
  cat > "$CONFIG_PATH" <<'EOF'
enabled = true
cli_mode = "both" # auto|copilot|gh|both
default_model = "claude-sonnet-4.5"
models = [
  "claude-sonnet-4.5",
  "claude-haiku-4.5",
  "claude-opus-4.5",
  "claude-sonnet-4",
  "gemini-3-pro-preview",
  "gpt-5.2-codex",
  "gpt-5.2",
  "gpt-5.1-codex-max",
  "gpt-5.1-codex",
  "gpt-5.1",
  "gpt-5",
  "gpt-5.1-codex-mini",
  "gpt-5-mini",
  "gpt-4.1",
]

# CLI args
copilot_args = ["--no-color", "--silent"]
gh_copilot_args = ["--no-color", "--silent"]

# Clipboard and terminal integration
clipboard_cmd = "wl-copy"
terminal_prefill_cmd = "bash -lc 'read -e -i %CMD% -p \">>> \" cmd; exec $SHELL'"

# Optional command extraction override
# command_extract_regex = "(?m)^\\$\\s+(.+)$"
EOF
  printf 'Wrote config -> %s\n' "$CONFIG_PATH"
fi

printf 'Restarting elephant to load provider...\n'
if command -v systemctl >/dev/null 2>&1; then
  systemctl --user restart elephant.service >/dev/null 2>&1 || true
fi

printf 'Done. Use walker prefix "~" to open Copilot provider.\n'
