#!/usr/bin/env bash
set -euo pipefail

# Waybar network launcher.
#
# Why this exists:
# - Some hosts use NetworkManager (best UX: `nmtui`/GUI)
# - Some hosts use iwd directly (fallback: `impala` or `iwctl`)
#
# This script picks the most appropriate available tool and launches it.

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DOTFILES_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
# shellcheck disable=SC1091
source "$DOTFILES_ROOT/scripts/lib/notifications.sh"

have() { command -v "$1" >/dev/null 2>&1; }

is_active() {
  # systemd might not be present in minimal environments; treat failures as inactive.
  systemctl is-active --quiet "$1" 2>/dev/null
}

notify() {
  local msg="$1"
  if have notify-send; then
    notify_send --app "dragon" --icon "network-wireless" "Network" "$msg"
  else
    printf '%s\n' "$msg" >&2
  fi
}

# Prefer impala when available (best UX).
# Note: on hosts where NetworkManager manages Wiâ€‘Fi, impala/iwd can fail with DBus NotSupported.
# GoldenDragon solves this by configuring NetworkManager to NOT manage wlan0 and enabling
# iwd's network configuration (see hosts/goldendragon/etc/).

# If an iwd GUI is installed, prefer it (doesn't need a terminal).
if have iwgtk; then
  exec iwgtk
fi

# iwd TUI for wifi management.
if have impala; then
  # Run impala in a floating terminal (Hyprland rules already float/center/size class "Impala")
  # and run it as root (some operations require elevated privileges).
  exec kitty --class=Impala --title=Impala bash -lc 'exec sudo -E impala'
fi

# Last resort: raw iwd shell.
if have iwctl; then
  # Keep the fallback TUI floating as well.
  exec kitty --class=termfloat --title=termfloat iwctl
fi

notify "No network UI found (need one of: nmtui/iwgtk/impala/iwctl)."
exit 1

