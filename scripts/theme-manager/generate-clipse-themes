#!/usr/bin/env bash
set -euo pipefail

# Generate theme-aware clipse configurations from hyprland-palette.conf

# Resolve script directory - works whether directly executed or stowed
SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" 2>/dev/null || echo "${BASH_SOURCE[0]}")")" && pwd)"

# Find theme-utils.sh relative to dotfiles root
DOTFILES_ROOT="$(cd "$SCRIPT_DIR/../../../.." && pwd)"
THEME_UTILS="$DOTFILES_ROOT/scripts/theme-manager/lib/theme-utils.sh"

if [[ ! -f "$THEME_UTILS" ]]; then
  echo "Error: theme-utils.sh not found at $THEME_UTILS" >&2
  exit 1
fi

# shellcheck source=../../../../scripts/theme-manager/lib/theme-utils.sh
source "$THEME_UTILS"

CLIPSE_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/clipse"
mkdir -p "$CLIPSE_CONFIG_DIR"

for theme in "$THEMES_DIR"/*/; do
  palette="$theme/hyprland-palette.conf"
  [[ -f "$palette" ]] || continue

  # Extract colors from palette
  background="$(tm_palette_hex "$palette" background)" || continue
  foreground="$(tm_palette_hex "$palette" foreground "$background")"
  accent="$(tm_palette_hex "$palette" accent "$foreground")"
  comment="$(tm_palette_hex "$palette" comment "$foreground")"
  green="$(tm_palette_hex "$palette" green "$accent")"
  red="$(tm_palette_hex "$palette" red "$accent")"
  blue="$(tm_palette_hex "$palette" blue "$accent")"
  yellow="$(tm_palette_hex "$palette" yellow "$accent")"
  magenta="$(tm_palette_hex "$palette" magenta "$accent")"
  cyan="$(tm_palette_hex "$palette" cyan "$accent")"

  # Generate derived colors
  surface="$(tm_hex_blend "$background" "#ffffff" 8)"
  selection="$(tm_hex_blend "$accent" "$background" 25)"
  border="$(tm_hex_blend "$accent" "$background" 40)"
  muted="$(tm_hex_blend "$foreground" "$comment" 60)"
  highlight="$(tm_hex_blend "$accent" "$foreground" 30)"

  # Create theme TOML file
  cat >"${theme%/}/clipse-theme.toml" <<EOF
# Auto-generated clipse theme from hyprland-palette.conf
# Generated by: scripts/theme-manager/generate-clipse-themes

[colors]
background = "$background"
foreground = "$foreground"
accent = "$accent"
surface = "$surface"
selection = "$selection"
border = "$border"
muted = "$muted"
highlight = "$highlight"

# Semantic colors
primary = "$accent"
secondary = "$comment"
success = "$green"
warning = "$yellow"
error = "$red"
info = "$blue"

# Syntax highlighting colors
keyword = "$magenta"
string = "$green"
number = "$yellow"
comment = "$comment"
function = "$blue"
variable = "$cyan"
type = "$accent"

[ui]
# Border and separator colors
border_color = "$border"
separator_color = "$muted"
scrollbar_color = "$accent"

# Selection and highlighting
selection_bg = "$selection"
selection_fg = "$foreground"
highlight_bg = "$highlight"
highlight_fg = "$background"

# Special UI elements
pin_indicator = "$yellow"
image_border = "$accent"
preview_border = "$blue"
search_match = "$green"

[statusbar]
background = "$surface"
foreground = "$foreground"
accent = "$accent"
mode_normal = "$blue"
mode_search = "$green"
mode_edit = "$yellow"
EOF

  echo "Generated clipse theme: ${theme%/}/clipse-theme.toml"
done

# Link current theme
CURRENT_THEME="${XDG_CONFIG_HOME:-$HOME/.config}/current/theme"
if [[ -d "$CURRENT_THEME" && -f "$CURRENT_THEME/clipse-theme.toml" ]]; then
  ln -sf "$CURRENT_THEME/clipse-theme.toml" "$CLIPSE_CONFIG_DIR/theme.toml"
  echo "Linked current theme to $CLIPSE_CONFIG_DIR/theme.toml"
fi

