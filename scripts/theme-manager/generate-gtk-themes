#!/usr/bin/env bash
set -euo pipefail

# Generate theme-aware GTK assets from hyprland-palette.conf
# - gtk.css: small GTK CSS overrides (primarily for Nemo)
# - gtk-3.0/settings.ini and gtk-4.0/settings.ini: per-theme GTK settings

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/theme-utils.sh
source "$SCRIPT_DIR/lib/theme-utils.sh"

for theme in "$THEMES_DIR"/*/; do
  palette="$theme/hyprland-palette.conf"
  [[ -f "$palette" ]] || continue

  theme_dir="${theme%/}"
  theme_name="$(basename "$theme_dir")"

  background="$(tm_palette_hex "$palette" background)" || continue
  foreground="$(tm_palette_hex "$palette" foreground "$background")"
  accent="$(tm_palette_hex "$palette" accent "$foreground" || true)"
  comment="$(tm_palette_hex "$palette" comment "$foreground" || true)"

  # Derived colors for UI elements
  header_bg="$background"
  if [[ -n "$comment" ]]; then
    header_bg="$(tm_hex_blend "$background" "$comment" 12)"
  fi

  selection_bg="$background"
  if [[ -n "$accent" ]]; then
    selection_bg="$(tm_hex_blend "$accent" "$background" 28)"
  fi
  selection_fg="$foreground"

  tm_read_setting() {
    local file="$1"
    [[ -f "$file" ]] || return 1
    # Trim whitespace; ignore empty lines and comments
    sed -e 's/#.*$//' -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' "$file" | awk 'NF{print; exit}'
  }

  prefer_dark=true
  if [[ -f "$theme_dir/light.mode" ]]; then
    prefer_dark=false
  fi

  # Prefer explicit per-theme GTK theme name overrides:
  # - gtk3-theme-name(.dark/.light), gtk4-theme-name(.dark/.light) (mode-specific)
  # - gtk3-theme-name, gtk4-theme-name (generic)
  # - gtk-theme-name(.dark/.light) (legacy generic)
  # Defaults (future-proof):
  # - GTK3: adw-gtk3(-dark)
  # - GTK4/libadwaita: Adwaita(-dark)
  gtk3_theme_name=""
  gtk4_theme_name=""
  if [[ "$prefer_dark" == "true" ]]; then
    gtk3_theme_name="$(tm_read_setting "$theme_dir/gtk3-theme-name.dark" || true)"
    gtk4_theme_name="$(tm_read_setting "$theme_dir/gtk4-theme-name.dark" || true)"
  else
    gtk3_theme_name="$(tm_read_setting "$theme_dir/gtk3-theme-name.light" || true)"
    gtk4_theme_name="$(tm_read_setting "$theme_dir/gtk4-theme-name.light" || true)"
  fi
  if [[ -z "$gtk3_theme_name" ]]; then
    gtk3_theme_name="$(tm_read_setting "$theme_dir/gtk3-theme-name" || true)"
  fi
  if [[ -z "$gtk4_theme_name" ]]; then
    gtk4_theme_name="$(tm_read_setting "$theme_dir/gtk4-theme-name" || true)"
  fi

  # Legacy generic overrides still supported.
  legacy_gtk_theme_name=""
  if [[ "$prefer_dark" == "true" ]]; then
    legacy_gtk_theme_name="$(tm_read_setting "$theme_dir/gtk-theme-name.dark" || true)"
  else
    legacy_gtk_theme_name="$(tm_read_setting "$theme_dir/gtk-theme-name.light" || true)"
  fi
  if [[ -z "$legacy_gtk_theme_name" ]]; then
    legacy_gtk_theme_name="$(tm_read_setting "$theme_dir/gtk-theme-name" || true)"
  fi
  if [[ -n "$legacy_gtk_theme_name" ]]; then
    [[ -z "$gtk3_theme_name" ]] && gtk3_theme_name="$legacy_gtk_theme_name"
    [[ -z "$gtk4_theme_name" ]] && gtk4_theme_name="$legacy_gtk_theme_name"
  fi

  # Defaults (best-practice, works broadly across distros when installed)
  if [[ -z "$gtk3_theme_name" ]]; then
    gtk3_theme_name="$([[ "$prefer_dark" == "true" ]] && printf '%s' 'adw-gtk3-dark' || printf '%s' 'adw-gtk3')"
  fi
  if [[ -z "$gtk4_theme_name" ]]; then
    gtk4_theme_name="$([[ "$prefer_dark" == "true" ]] && printf '%s' 'Adwaita-dark' || printf '%s' 'Adwaita')"
  fi

  # Ensure canonical override locations exist
  mkdir -p "$theme_dir/gtk-3.0" "$theme_dir/gtk-4.0"

  # GTK3 override CSS (Nemo-focused, but includes robust selectors for GTK3 widgets)
  cat >"$theme_dir/gtk-3.0/gtk.css" <<EOF
/*
 * ${theme_name} GTK CSS
 *
 * This file is managed by the dotfiles theme-manager.
 * Any manual changes will be overwritten.
 *
 * Generated by: scripts/theme-manager/generate-gtk-themes
 */

@define-color tm_window_bg ${background};
@define-color tm_window_fg ${foreground};
@define-color tm_header_bg ${header_bg};
@define-color tm_selection_bg ${selection_bg};
@define-color tm_selection_fg ${selection_fg};

/* ---------------------------
 * Nemo (GTK3) targeted styles
 * --------------------------- */

/* Window base */
.nemo-window,
.nemo-window.background {
  background-color: @tm_window_bg;
  color: @tm_window_fg;
}

/* Headerbar / toolbars (Nemo uses regular toolbars; include headerbar for completeness) */
.nemo-window headerbar,
.nemo-window .header-bar,
.nemo-window toolbar,
.nemo-window .toolbar {
  background-color: @tm_header_bg;
  color: @tm_window_fg;
}

/* Sidebar (GtkPlacesSidebar is usually style class "sidebar") */
.nemo-window .sidebar,
.nemo-window placessidebar,
.nemo-window .sidebar treeview.view,
.nemo-window .sidebar .view {
  background-color: @tm_window_bg;
  color: @tm_window_fg;
}

/* Ensure labels/icons inside sidebar inherit foreground */
.nemo-window .sidebar *,
.nemo-window placessidebar * {
  color: @tm_window_fg;
}

/* Main file view area */
.nemo-window .view,
.nemo-window iconview,
.nemo-window treeview.view {
  background-color: @tm_window_bg;
  color: @tm_window_fg;
}

/* Selection (best-effort across iconview/treeview/listbox) */
.nemo-window .view:selected,
.nemo-window treeview.view:selected,
.nemo-window row:selected,
.nemo-window .sidebar row:selected {
  background-color: @tm_selection_bg;
  color: @tm_selection_fg;
}

/* Focused selection variants */
.nemo-window .view:selected:focus,
.nemo-window treeview.view:selected:focus,
.nemo-window row:selected:focus {
  background-color: @tm_selection_bg;
  color: @tm_selection_fg;
}
EOF

  # Back-compat: keep theme-root gtk.css for older scripts/configs.
  cp "$theme_dir/gtk-3.0/gtk.css" "$theme_dir/gtk.css"

  # GTK4/libadwaita override CSS
  #
  # Goal: future-proof palette application by overriding libadwaita color tokens
  # rather than trying to restyle widget internals.
  #
  # Reference: libadwaita CSS variables documentation (names can expand over time).
  view_bg="$background"
  if [[ -n "$foreground" ]]; then
    view_bg="$(tm_hex_blend "$background" "$foreground" 3)"
  fi
  popover_bg="$background"
  if [[ -n "$foreground" ]]; then
    popover_bg="$(tm_hex_blend "$background" "$foreground" 6)"
  fi
  border_color="$background"
  if [[ -n "$foreground" ]]; then
    border_color="$(tm_hex_blend "$background" "$foreground" 18)"
  fi
  accent_bg="${accent:-$selection_bg}"
  accent_fg="$background"

  cat >"$theme_dir/gtk-4.0/gtk.css" <<EOF
/*
 * ${theme_name} GTK4 / libadwaita color overrides
 *
 * Managed by the dotfiles theme-manager.
 * Generated by: scripts/theme-manager/generate-gtk-themes
 *
 * This intentionally focuses on libadwaita color tokens for stability.
 */

:root {
  /* Base surfaces */
  --window-bg-color: ${background};
  --window-fg-color: ${foreground};
  --view-bg-color: ${view_bg};
  --view-fg-color: ${foreground};
  --headerbar-bg-color: ${header_bg};
  --headerbar-fg-color: ${foreground};
  --popover-bg-color: ${popover_bg};
  --popover-fg-color: ${foreground};
  --borders-color: ${border_color};

  /* Accent / selection */
  --accent-bg-color: ${accent_bg};
  --accent-fg-color: ${accent_fg};
  --accent-color: ${accent_bg};
}
EOF

  # GTK settings.ini (GTK3 + GTK4)
  cat >"$theme_dir/gtk-3.0/settings.ini" <<EOF
[Settings]
# Auto-generated from hyprland-palette.conf (and light.mode if present).
# Generated by: scripts/theme-manager/generate-gtk-themes
gtk-application-prefer-dark-theme=${prefer_dark}
gtk-theme-name=${gtk3_theme_name}
EOF

  cat >"$theme_dir/gtk-4.0/settings.ini" <<EOF
[Settings]
# Auto-generated from hyprland-palette.conf (and light.mode if present).
# Generated by: scripts/theme-manager/generate-gtk-themes
gtk-application-prefer-dark-theme=${prefer_dark}
gtk-theme-name=${gtk4_theme_name}
EOF

  echo "Wrote ${theme_dir}/gtk-3.0/gtk.css"
  echo "Wrote ${theme_dir}/gtk-4.0/gtk.css"
  echo "Wrote ${theme_dir}/gtk.css"
  echo "Wrote ${theme_dir}/gtk-3.0/settings.ini"
  echo "Wrote ${theme_dir}/gtk-4.0/settings.ini"
done

