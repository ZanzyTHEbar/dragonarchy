#!/bin/bash
# theme-set: Set a theme, specified by its name.
# Usage: theme-set [--no-gui] <theme-name>

# Parse arguments
NO_GUI=false
THEME_NAME=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --no-gui)
            NO_GUI=true
            shift
        ;;
        *)
            THEME_NAME="$1"
            shift
        ;;
    esac
done

if [[ -z "$THEME_NAME" ]]; then
    echo "Usage: theme-set [--no-gui] <theme-name>" >&2
    exit 1
fi

schedule_ui_refresh() {
    setsid bash -c '
        sleep 0.15
        command pkill -USR1 -x kitty >/dev/null 2>&1 || true
        command pkill -SIGUSR2 btop >/dev/null 2>&1 || true
        command pkill -SIGUSR2 waybar >/dev/null 2>&1 || true
        if command -v hyprctl >/dev/null 2>&1; then
            hyprctl reload >/dev/null 2>&1 || true
        fi
        if command -v swaync-client >/dev/null 2>&1 && command pgrep -x swaync >/dev/null 2>&1; then
            swaync-client -R >/dev/null 2>&1 || true
        fi
        if command pgrep -x nemo >/dev/null 2>&1; then
            nemo -q
            setsid nemo >/dev/null 2>&1 &
        fi
    ' >/dev/null 2>&1 </dev/null &
}

{
    printf '%s START NO_GUI=%s THEME=%s\n' "$(date --iso-8601=seconds)" "$NO_GUI" "$THEME_NAME"
} >>/tmp/theme-set.log 2>/dev/null || true

# Get the script directory (resolve symlinks) and resolve to absolute path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
THEMES_DIR="$(cd "$SCRIPT_DIR/../../packages/themes/.config/themes" && pwd)"
CURRENT_THEME_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/current/theme"

THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Check if the theme entered exists
if [[ ! -d "$THEME_PATH" ]]; then
    echo "Theme '$THEME_NAME' does not exist in $THEMES_DIR" >&2
    exit 2
fi

# Update theme symlink with absolute path
mkdir -p "$(dirname "$CURRENT_THEME_DIR")"
ln -Tnsf "$THEME_PATH" "$CURRENT_THEME_DIR"

{
    printf '%s LINK CURRENT_THEME_DIR=%s TARGET=%s RESOLVED=%s\n' \
    "$(date --iso-8601=seconds)" \
    "$CURRENT_THEME_DIR" \
    "$THEME_PATH" \
    "$(readlink -f "$CURRENT_THEME_DIR" 2>/dev/null || echo unknown)"
} >>/tmp/theme-set.log 2>/dev/null || true

# "Compile" the dynamic theme colors into a static file for Hyprland to source
[ -f "$THEME_PATH/hyprland-palette.conf" ] && cp "$THEME_PATH/hyprland-palette.conf" ~/.config/hypr/colors-theme.conf || true

# Change GNOME modes (best-effort; skip if gsettings or DBus not available)
if command -v gsettings >/dev/null 2>&1; then
    if [[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/theme/light.mode" ]]; then
        timeout 2s gsettings set org.gnome.desktop.interface color-scheme "prefer-light" >/dev/null 2>&1 || true
        timeout 2s gsettings set org.gnome.desktop.interface gtk-theme "Adwaita" >/dev/null 2>&1 || true
    else
        timeout 2s gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" >/dev/null 2>&1 || true
        timeout 2s gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark" >/dev/null 2>&1 || true
    fi
fi

# Set btop theme
mkdir -p ~/.config/btop/themes
# Use a relative symlink (avoid absolute links which confuse stow and are less portable)
ln -snf ../../current/theme/btop.theme ~/.config/btop/themes/current.theme

# Set walker theme (Walker expects themes/<name>/style.css)
WALKER_THEMES_ROOT="${XDG_CONFIG_HOME:-$HOME/.config}/walker/themes"
mkdir -p "$WALKER_THEMES_ROOT/$THEME_NAME"
rm -f "$WALKER_THEMES_ROOT/default.css"

# If the theme CSS is already stow-managed (or otherwise present), do not overwrite it.
# Only copy from the current theme if the destination doesn't exist yet.
if [[ -f "$CURRENT_THEME_DIR/walker.css" && ! -e "$WALKER_THEMES_ROOT/$THEME_NAME/style.css" ]]; then
    cp "$CURRENT_THEME_DIR/walker.css" "$WALKER_THEMES_ROOT/$THEME_NAME/style.css"
fi

# Maintain a convenience symlink for scripts that still reference themes/current
mkdir -p "$WALKER_THEMES_ROOT/current"
if [[ -e "$WALKER_THEMES_ROOT/$THEME_NAME/style.css" ]]; then
    # Relative symlink within walker themes root
    ln -snf "../$THEME_NAME/style.css" "$WALKER_THEMES_ROOT/current/style.css"
fi

if [[ -f "$CURRENT_THEME_DIR/walker.toml" ]]; then
    if [[ ! -e "$WALKER_THEMES_ROOT/$THEME_NAME/layout.toml" ]]; then
        cp "$CURRENT_THEME_DIR/walker.toml" "$WALKER_THEMES_ROOT/$THEME_NAME/layout.toml"
    fi
    ln -snf "../$THEME_NAME/layout.toml" "$WALKER_THEMES_ROOT/current/layout.toml"
else
    rm -f "$WALKER_THEMES_ROOT/current/layout.toml"
fi

# Walker theme selection:
# Our stow-managed Walker config uses `theme = "current"`, and we keep
# ~/.config/walker/themes/current/style.css pointed at the chosen theme above.
# This avoids rewriting stow-managed config.toml (which would break symlinks).

# Set GTK theme for Nemo
mkdir -p ~/.config/gtk-3.0
ln -snf ~/.config/current/theme/gtk.css ~/.config/gtk-3.0/gtk.css

# Generate kitty theme from palettes and link current
"$SCRIPT_DIR/generate-kitty-themes" >/dev/null 2>&1 || true
"$SCRIPT_DIR/generate-walker-themes" >/dev/null 2>&1 || true
"$SCRIPT_DIR/generate-clipse-themes" >/dev/null 2>&1 || true

mkdir -p "$HOME/.config/kitty"
ln -snf "$CURRENT_THEME_DIR/kitty.conf" "$HOME/.config/kitty/colors.conf"

# NOTE: Do not rewrite ~/.config/kitty/kitty.conf here.
# It's stow-managed in this repo, and rewriting it (via mv/sed -i) would break the symlink
# and cause stow conflicts on the next install/update.

# Restart walker to pick up theme changes
if command -v walker-restart >/dev/null 2>&1; then
    walker-restart >/dev/null 2>&1 || true
else
    command pkill -x walker >/dev/null 2>&1 || true
    setsid uwsm app -- walker --gapplication-service >/dev/null 2>&1 &
fi

# Link wlogout CSS for this theme if provided
if [[ -f "$CURRENT_THEME_DIR/wlogout.css" ]]; then
    mkdir -p "$HOME/.config/wlogout"
    ln -snf "$CURRENT_THEME_DIR/wlogout.css" "$HOME/.config/wlogout/wlogout.css"
fi

# Configure zsh autosuggestions to use theme accent
if [[ -f "$CURRENT_THEME_DIR/hyprland-palette.conf" ]]; then
    ACCENT_HEX=$(awk '$1=="$accent"{print $3}' "$CURRENT_THEME_DIR/hyprland-palette.conf" | sed -E 's/rgba\(([^)]*)\)/#\1/' | cut -c1-7)
    if [[ -n "$ACCENT_HEX" ]]; then
        mkdir -p "$HOME/.config/zsh"
        echo "export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=fg=$ACCENT_HEX" >"$HOME/.config/zsh/autosuggest-theme.zsh"
    fi
fi

# Best-effort: align SDDM theme family with current theme name if matching exists
SDDM_THEMES_DIR="$(cd "$SCRIPT_DIR/../../packages/sddm/usr/share/sddm/themes" 2>/dev/null && pwd || echo '')"
if [[ -n "$SDDM_THEMES_DIR" && -d "$SDDM_THEMES_DIR/$THEME_NAME" ]]; then
    echo "Found matching SDDM theme '$THEME_NAME'. Applying..."
    "$SCRIPT_DIR/sddm-set" "$THEME_NAME" || true
fi

# Always update background link; skip compositor reload when --no-gui is set
THEME_BG_ARGS=()
if [[ "$NO_GUI" == "true" ]]; then
    THEME_BG_ARGS+=(--skip-apply)
fi

{
    printf '%s CALL theme-bg-next args=%q\n' \
    "$(date --iso-8601=seconds)" \
    "${THEME_BG_ARGS[*]}"
} >>/tmp/theme-set.log 2>/dev/null || true

THEME_BG_OUTPUT=$("$SCRIPT_DIR/theme-bg-next" "${THEME_BG_ARGS[@]}" 2>&1)
THEME_BG_STATUS=$?

{
    printf '%s CALL_DONE status=%s output=%s\n' \
    "$(date --iso-8601=seconds)" \
    "$THEME_BG_STATUS" \
    "$(printf '%s' "$THEME_BG_OUTPUT" | tr '\n' ';')"
} >>/tmp/theme-set.log 2>/dev/null || true
{
    printf '%s DONE THEME=%s BACKGROUND_LINK=%s\n' \
    "$(date --iso-8601=seconds)" \
    "$THEME_NAME" \
    "$(readlink -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/background" 2>/dev/null || echo none)"
} >>/tmp/theme-set.log 2>/dev/null || true

if [[ "$NO_GUI" == "false" ]]; then
    schedule_ui_refresh
fi
