#!/bin/bash
# theme-set: Set a theme, specified by its name.
# Usage: theme-set [--no-gui] <theme-name>

# Parse arguments
NO_GUI=false
THEME_NAME=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --no-gui)
            NO_GUI=true
            shift
        ;;
        *)
            THEME_NAME="$1"
            shift
        ;;
    esac
done

if [[ -z "$THEME_NAME" ]]; then
    echo "Usage: theme-set [--no-gui] <theme-name>" >&2
    exit 1
fi

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/dragon/theme-manager"
mkdir -p "$STATE_DIR"
RECENTS_FILE="$STATE_DIR/recent-themes"
PREV_THEME_FILE="$STATE_DIR/prev-theme"

record_recent_theme() {
    local slug="$1"
    [[ -z "$slug" ]] && return 0
    local tmp; tmp="$(mktemp)"
    {
        echo "$slug"
        [[ -f "$RECENTS_FILE" ]] && cat "$RECENTS_FILE" || true
    } | awk 'NF && !seen[$0]++' | head -n 10 >"$tmp"
    mv -f "$tmp" "$RECENTS_FILE"
}

record_prev_theme() {
    local link="$1"
    if [[ -L "$link" ]]; then
        local cur; cur="$(basename "$(readlink -f "$link" 2>/dev/null || true)")"
        [[ -n "$cur" ]] && printf '%s\n' "$cur" >"$PREV_THEME_FILE"
    fi
}

schedule_ui_refresh() {
    setsid bash -c '
        sleep 0.15
        command pkill -USR1 -x kitty >/dev/null 2>&1 || true
        command pkill -SIGUSR2 btop >/dev/null 2>&1 || true
        command pkill -SIGUSR2 waybar >/dev/null 2>&1 || true
        command pkill --signal USR2 -f workspace-indicator --ignore-ancestors >/dev/null 2>&1 || true
        if command -v hyprctl >/dev/null 2>&1; then
            hyprctl reload >/dev/null 2>&1 || true
        fi
        # Restart swaync: GTK CSS provider caches resolved @import paths,
        # so swaync-client -rs does not re-resolve symlink targets.
        # swaync ignores SIGTERM/SIGINT; SIGKILL is required.
        if command pgrep -x swaync >/dev/null 2>&1; then
            command pkill --signal KILL -x swaync >/dev/null 2>&1 || true
            sleep 0.5
            setsid uwsm app -- swaync >/dev/null 2>&1 &
        fi

        # Force GTK4/libadwaita live reload: toggle color-scheme so portal
        # emits SettingChanged, causing CssProvider to re-read CSS from disk (GTK 4.20+).
        if command -v gsettings >/dev/null 2>&1; then
            cs=$(gsettings get org.gnome.desktop.interface color-scheme 2>/dev/null | tr -d "'\''" || true)
            if [[ -n "$cs" ]]; then
                gsettings set org.gnome.desktop.interface color-scheme "default" 2>/dev/null || true
                sleep 0.05
                gsettings set org.gnome.desktop.interface color-scheme "$cs" 2>/dev/null || true
            fi

            # Force GTK3 live reload: toggle gtk-theme so apps reload the theme
            # and re-read user CSS from disk.
            gt=$(gsettings get org.gnome.desktop.interface gtk-theme 2>/dev/null | tr -d "'\''" || true)
            if [[ -n "$gt" ]]; then
                gsettings set org.gnome.desktop.interface gtk-theme "Adwaita" 2>/dev/null || true
                sleep 0.05
                gsettings set org.gnome.desktop.interface gtk-theme "$gt" 2>/dev/null || true
            fi
        fi

        # Nemo fallback: restart if running (GTK3 may not always respond to gsettings toggle)
        if command pgrep -x nemo >/dev/null 2>&1; then
            nemo -q
            setsid nemo >/dev/null 2>&1 &
        fi
    ' >/dev/null 2>&1 </dev/null &
}

{
    printf '%s START NO_GUI=%s THEME=%s\n' "$(date --iso-8601=seconds)" "$NO_GUI" "$THEME_NAME"
} >>/tmp/theme-set.log 2>/dev/null || true

# Get the script directory (resolve symlinks) and resolve to absolute path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
THEMES_DIR="$(cd "$SCRIPT_DIR/../../packages/themes/.config/themes" && pwd)"
CURRENT_THEME_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/current/theme"

THEME_PATH="$THEMES_DIR/$THEME_NAME"

# Check if the theme entered exists
if [[ ! -d "$THEME_PATH" ]]; then
    echo "Theme '$THEME_NAME' does not exist in $THEMES_DIR" >&2
    exit 2
fi

# Record previous theme for undo and record recents
record_prev_theme "$CURRENT_THEME_DIR"
record_recent_theme "$THEME_NAME"

# Update theme symlink with absolute path
mkdir -p "$(dirname "$CURRENT_THEME_DIR")"
ln -Tnsf "$THEME_PATH" "$CURRENT_THEME_DIR"

{
    printf '%s LINK CURRENT_THEME_DIR=%s TARGET=%s RESOLVED=%s\n' \
    "$(date --iso-8601=seconds)" \
    "$CURRENT_THEME_DIR" \
    "$THEME_PATH" \
    "$(readlink -f "$CURRENT_THEME_DIR" 2>/dev/null || echo unknown)"
} >>/tmp/theme-set.log 2>/dev/null || true

# "Compile" the dynamic theme colors into a static file for Hyprland to source
[ -f "$THEME_PATH/hyprland-palette.conf" ] && cp "$THEME_PATH/hyprland-palette.conf" ~/.config/hypr/colors-theme.conf || true

# Set btop theme
mkdir -p ~/.config/btop/themes
# Use a relative symlink (avoid absolute links which confuse stow and are less portable)
ln -snf ../../current/theme/btop.theme ~/.config/btop/themes/current.theme

# Set walker theme (Walker expects themes/<name>/style.css)
WALKER_THEMES_ROOT="${XDG_CONFIG_HOME:-$HOME/.config}/walker/themes"
mkdir -p "$WALKER_THEMES_ROOT/$THEME_NAME"
rm -f "$WALKER_THEMES_ROOT/default.css"

# If the theme CSS is already stow-managed (or otherwise present), do not overwrite it.
# Only copy from the current theme if the destination doesn't exist yet.
if [[ -f "$CURRENT_THEME_DIR/walker.css" && ! -e "$WALKER_THEMES_ROOT/$THEME_NAME/style.css" ]]; then
    cp "$CURRENT_THEME_DIR/walker.css" "$WALKER_THEMES_ROOT/$THEME_NAME/style.css"
fi

# Maintain a convenience symlink for scripts that still reference themes/current
mkdir -p "$WALKER_THEMES_ROOT/current"
if [[ -e "$WALKER_THEMES_ROOT/$THEME_NAME/style.css" ]]; then
    # Relative symlink within walker themes root
    ln -snf "../$THEME_NAME/style.css" "$WALKER_THEMES_ROOT/current/style.css"
fi

if [[ -f "$CURRENT_THEME_DIR/walker.toml" ]]; then
    if [[ ! -e "$WALKER_THEMES_ROOT/$THEME_NAME/layout.toml" ]]; then
        cp "$CURRENT_THEME_DIR/walker.toml" "$WALKER_THEMES_ROOT/$THEME_NAME/layout.toml"
    fi
    ln -snf "../$THEME_NAME/layout.toml" "$WALKER_THEMES_ROOT/current/layout.toml"
else
    rm -f "$WALKER_THEMES_ROOT/current/layout.toml"
fi

# Walker theme selection:
# Our stow-managed Walker config uses `theme = "current"`, and we keep
# ~/.config/walker/themes/current/style.css pointed at the chosen theme above.
# This avoids rewriting stow-managed config.toml (which would break symlinks).

# Set GTK theme for Nemo
mkdir -p ~/.config/gtk-3.0 ~/.config/gtk-4.0

# Generate GTK theme assets (gtk.css + settings.ini) from palette, then link current.
"$SCRIPT_DIR/generate-gtk-themes" >/dev/null 2>&1 || true

# Apply GTK CSS overrides (copy, not symlink â€” enables GFileMonitor to detect changes).
# --remove-destination handles the case where old symlinks point to the same resolved file.
# - GTK3: Adwaita @define-color overrides + Nemo selectors
# - GTK4: libadwaita :root color token overrides
if [[ -f "$HOME/.config/current/theme/gtk-3.0/gtk.css" ]]; then
    cp --remove-destination "$HOME/.config/current/theme/gtk-3.0/gtk.css" "$HOME/.config/gtk-3.0/gtk.css"
elif [[ -f "$HOME/.config/current/theme/gtk.css" ]]; then
    cp --remove-destination "$HOME/.config/current/theme/gtk.css" "$HOME/.config/gtk-3.0/gtk.css"
fi

if [[ -f "$HOME/.config/current/theme/gtk-4.0/gtk.css" ]]; then
    cp --remove-destination "$HOME/.config/current/theme/gtk-4.0/gtk.css" "$HOME/.config/gtk-4.0/gtk.css"
else
    # No GTK4 overrides for this theme; remove stale file
    rm -f "$HOME/.config/gtk-4.0/gtk.css"
fi

# Apply GTK settings.ini if present for this theme
GTK3_BASE="$HOME/.config/gtk-3.0/settings.base.ini"
GTK4_BASE="$HOME/.config/gtk-4.0/settings.base.ini"
GTK3_THEME="$HOME/.config/current/theme/gtk-3.0/settings.ini"
GTK4_THEME="$HOME/.config/current/theme/gtk-4.0/settings.ini"

GTK3_OUT="$HOME/.config/gtk-3.0/settings.ini"
GTK4_OUT="$HOME/.config/gtk-4.0/settings.ini"

if [[ -f "$GTK3_BASE" ]]; then
    cp "$GTK3_BASE" "$GTK3_OUT"
else
    printf '[Settings]\n' >"$GTK3_OUT"
fi
if [[ -f "$GTK3_THEME" ]]; then
    awk 'BEGIN{in_settings=0} /^\[Settings\]/{in_settings=1; next} {if(in_settings) print}' "$GTK3_THEME" >>"$GTK3_OUT"
fi

if [[ -f "$GTK4_BASE" ]]; then
    cp "$GTK4_BASE" "$GTK4_OUT"
else
    printf '[Settings]\n' >"$GTK4_OUT"
fi
if [[ -f "$GTK4_THEME" ]]; then
    awk 'BEGIN{in_settings=0} /^\[Settings\]/{in_settings=1; next} {if(in_settings) print}' "$GTK4_THEME" >>"$GTK4_OUT"
fi

# If the selected GTK3 theme isn't installed, fall back to Adwaita to avoid mismatched/broken theming.
gtk_theme_installed() {
    local name="$1"
    [[ -z "$name" ]] && return 1
    local d
    for d in \
        "$HOME/.local/share/themes" \
        "$HOME/.themes" \
        "/usr/local/share/themes" \
        "/usr/share/themes"
    do
        [[ -d "$d/$name" ]] && return 0
    done
    return 1
}

GTK3_NAME="$(awk -F= '/^gtk-theme-name=/{val=$2} END{print val}' "$GTK3_OUT" 2>/dev/null | tr -d '\r' || true)"
if [[ -n "$GTK3_NAME" ]] && ! gtk_theme_installed "$GTK3_NAME"; then
    if [[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/theme/light.mode" ]]; then
        GTK3_FALLBACK="Adwaita"
    else
        GTK3_FALLBACK="Adwaita-dark"
    fi
    # Replace the gtk-theme-name line (uncommented) with the fallback.
    sed -i '/^gtk-theme-name=/d' "$GTK3_OUT"
    if [[ -s "$GTK3_OUT" && "$(tail -c1 "$GTK3_OUT" 2>/dev/null || true)" != $'\n' ]]; then
        printf '\n' >>"$GTK3_OUT"
    fi
    printf 'gtk-theme-name=%s\n' "$GTK3_FALLBACK" >>"$GTK3_OUT"
fi

# Change GNOME modes (best-effort; skip if gsettings or DBus not available)
if command -v gsettings >/dev/null 2>&1; then
    if [[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/theme/light.mode" ]]; then
        timeout 2s gsettings set org.gnome.desktop.interface color-scheme "prefer-light" >/dev/null 2>&1 || true
    else
        timeout 2s gsettings set org.gnome.desktop.interface color-scheme "prefer-dark" >/dev/null 2>&1 || true
    fi

    GTK_GSET_THEME="$(awk -F= '/^gtk-theme-name=/{val=$2} END{print val}' "$GTK3_OUT" 2>/dev/null | tr -d '\r' || true)"
    if [[ -n "$GTK_GSET_THEME" ]]; then
        timeout 2s gsettings set org.gnome.desktop.interface gtk-theme "$GTK_GSET_THEME" >/dev/null 2>&1 || true
    fi
fi

# Generate kitty theme from palettes and link current
"$SCRIPT_DIR/generate-kitty-themes" >/dev/null 2>&1 || true
"$SCRIPT_DIR/generate-walker-themes" >/dev/null 2>&1 || true
"$SCRIPT_DIR/generate-swaync-themes" >/dev/null 2>&1 || true
"$SCRIPT_DIR/generate-clipse-themes" >/dev/null 2>&1 || true

mkdir -p "$HOME/.config/kitty"
ln -snf "$CURRENT_THEME_DIR/kitty.conf" "$HOME/.config/kitty/colors.conf"

# NOTE: Do not rewrite ~/.config/kitty/kitty.conf here.
# It's stow-managed in this repo, and rewriting it (via mv/sed -i) would break the symlink
# and cause stow conflicts on the next install/update.

# Restart walker to pick up theme changes
if [[ "${DRAGON_SKIP_WALKER_RESTART:-0}" != "1" ]]; then
    if command -v walker-restart >/dev/null 2>&1; then
        walker-restart >/dev/null 2>&1 || true
    else
        command pkill -x walker >/dev/null 2>&1 || true
        setsid uwsm app -- walker --gapplication-service >/dev/null 2>&1 &
    fi
fi

# Link wlogout CSS for this theme if provided
if [[ -f "$CURRENT_THEME_DIR/wlogout.css" ]]; then
    mkdir -p "$HOME/.config/wlogout"
    ln -snf "$CURRENT_THEME_DIR/wlogout.css" "$HOME/.config/wlogout/wlogout.css"
fi

# Configure zsh autosuggestions to use theme accent
if [[ -f "$CURRENT_THEME_DIR/hyprland-palette.conf" ]]; then
    ACCENT_HEX=$(awk '$1=="$accent"{print $3}' "$CURRENT_THEME_DIR/hyprland-palette.conf" | sed -E 's/rgba\(([^)]*)\)/#\1/' | cut -c1-7)
    if [[ -n "$ACCENT_HEX" ]]; then
        mkdir -p "$HOME/.config/zsh"
        echo "export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE=fg=$ACCENT_HEX" >"$HOME/.config/zsh/autosuggest-theme.zsh"
    fi
fi

# Best-effort: align SDDM theme family with current theme name if matching exists
SDDM_THEMES_DIR="$(cd "$SCRIPT_DIR/../../packages/sddm/usr/share/sddm/themes" 2>/dev/null && pwd || echo '')"
if [[ -n "$SDDM_THEMES_DIR" && -d "$SDDM_THEMES_DIR/$THEME_NAME" ]]; then
    echo "Found matching SDDM theme '$THEME_NAME'. Applying..."
    "$SCRIPT_DIR/sddm-set" "$THEME_NAME" || true
fi

# Always update background link; skip compositor reload when --no-gui is set
THEME_BG_ARGS=()
if [[ "$NO_GUI" == "true" ]]; then
    THEME_BG_ARGS+=(--skip-apply)
fi

{
    printf '%s CALL theme-bg-next args=%q\n' \
    "$(date --iso-8601=seconds)" \
    "${THEME_BG_ARGS[*]}"
} >>/tmp/theme-set.log 2>/dev/null || true

THEME_BG_OUTPUT=$("$SCRIPT_DIR/theme-bg-next" "${THEME_BG_ARGS[@]}" 2>&1)
THEME_BG_STATUS=$?

{
    printf '%s CALL_DONE status=%s output=%s\n' \
    "$(date --iso-8601=seconds)" \
    "$THEME_BG_STATUS" \
    "$(printf '%s' "$THEME_BG_OUTPUT" | tr '\n' ';')"
} >>/tmp/theme-set.log 2>/dev/null || true
{
    printf '%s DONE THEME=%s BACKGROUND_LINK=%s\n' \
    "$(date --iso-8601=seconds)" \
    "$THEME_NAME" \
    "$(readlink -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/background" 2>/dev/null || echo none)"
} >>/tmp/theme-set.log 2>/dev/null || true

if [[ "$NO_GUI" == "false" ]]; then
    schedule_ui_refresh
fi
