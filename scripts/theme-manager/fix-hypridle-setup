#!/usr/bin/env bash
# Comprehensive fix for hypridle and hyprlock issues

set -euo pipefail

echo "ðŸ”§ Hypridle & Hyprlock Setup Fix"
echo "==============================="

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"
# Calculate dotfiles directory more reliably
if [[ "$SCRIPT_DIR" == */dotfiles/scripts/theme-manager ]]; then
    DOTFILES_DIR="${SCRIPT_DIR%/scripts/theme-manager}"
else
    # Fallback to finding dotfiles directory
    DOTFILES_DIR="$(cd "$SCRIPT_DIR/../../../" &>/dev/null && pwd)"
fi

echo "Script dir: $SCRIPT_DIR"
echo "Dotfiles dir: $DOTFILES_DIR"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Check if running as root for system-level changes
if [[ $EUID -eq 0 ]]; then
    log_error "This script should not be run as root. It will prompt for sudo when needed."
    exit 1
fi

# Step 1: Install hypridle configuration
log_info "Installing hypridle configuration..."
HYPR_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/hypr"
HYPRIDLE_CONF="$HYPR_CONFIG_DIR/config/hypridle.conf"
DOTFILES_HYPRIDLE="$DOTFILES_DIR/packages/hyprland/hypridle.conf"

mkdir -p "$HYPR_CONFIG_DIR/config"

if [[ -f "$DOTFILES_HYPRIDLE" ]]; then
    cp "$DOTFILES_HYPRIDLE" "$HYPRIDLE_CONF"
    log_success "hypridle.conf installed to $HYPRIDLE_CONF"
else
    log_error "hypridle.conf not found in dotfiles. Please ensure it's created."
    exit 1
fi

# Step 2: Install PAM configuration
log_info "Installing PAM configuration for hyprlock..."
PAM_CONF="/etc/pam.d/hyprlock"
DOTFILES_PAM="$DOTFILES_DIR/packages/hyprland/hyprlock.pam"

if [[ -f "$DOTFILES_PAM" ]]; then
    sudo cp "$DOTFILES_PAM" "$PAM_CONF"
    sudo chmod 644 "$PAM_CONF"
    log_success "PAM configuration installed to $PAM_CONF"
else
    log_error "hyprlock.pam not found in dotfiles. Please ensure it's created."
    exit 1
fi

# Step 3: Ensure hyprlock configuration exists
log_info "Ensuring hyprlock configuration exists..."
HYPRLOCK_CONF="$HYPR_CONFIG_DIR/hyprlock.conf"
if [[ ! -f "$HYPRLOCK_CONF" ]]; then
    if command -v hyprlock >/dev/null 2>&1; then
        "$SCRIPT_DIR/hyprlock-setup"
        log_success "hyprlock configuration created"
    else
        log_warning "hyprlock command not found. Please install hyprlock."
    fi
fi

# Step 4: Configure systemd logind for better power management
log_info "Configuring systemd logind..."
LOGIND_CONF="/etc/systemd/logind.conf"

# Backup existing config if it exists
if [[ -f "$LOGIND_CONF" ]] && ! grep -q "HandleLidSwitch" "$LOGIND_CONF"; then
    sudo cp "$LOGIND_CONF" "${LOGIND_CONF}.backup.$(date +%Y%m%d_%H%M%S)"
    log_info "Backed up existing logind.conf"
fi

# Add power management settings
sudo tee -a "$LOGIND_CONF" >/dev/null <<EOF

# Hyprland power management settings
HandleLidSwitch=suspend
HandleLidSwitchExternalPower=suspend
HandleLidSwitchDocked=ignore
IdleAction=suspend
IdleActionSec=30min
EOF

log_success "systemd logind configured"

# Step 5: Reload systemd configuration
log_info "Reloading systemd configuration..."
sudo systemctl daemon-reload

# Step 6: Enable and start power management services
log_info "Configuring power management services..."

# Restart logind to apply changes
sudo systemctl restart systemd-logind

# Enable suspend target
sudo systemctl enable suspend.target

# Step 7: Test configuration
log_info "Testing configuration..."

# Test hypridle configuration
if [[ -f "$HYPRIDLE_CONF" ]]; then
    log_success "hypridle.conf exists and is readable"
else
    log_error "hypridle.conf is missing or not readable"
fi

# Test PAM configuration
if [[ -f "$PAM_CONF" ]]; then
    log_success "PAM configuration exists"
else
    log_error "PAM configuration is missing"
fi

# Test hyprlock configuration
if [[ -f "$HYPRLOCK_CONF" ]]; then
    log_success "hyprlock.conf exists"
else
    log_warning "hyprlock.conf is missing - run hyprlock-setup if needed"
fi

# Step 8: Restart services
log_info "Restarting idle management services..."

# Stop any running hypridle
pkill -x hypridle 2>/dev/null || true

# Start hypridle with new configuration
if command -v uwsm >/dev/null 2>&1; then
    uwsm app -- hypridle -c "$HYPRIDLE_CONF" >/dev/null 2>&1 &
    disown
    log_success "hypridle started via uwsm"
elif command -v hypridle >/dev/null 2>&1; then
    hypridle -c "$HYPRIDLE_CONF" >/dev/null 2>&1 &
    disown
    log_success "hypridle started directly"
else
    log_warning "hypridle command not found"
fi

# Step 9: Verify services are running
sleep 2
if pgrep -x hypridle >/dev/null; then
    log_success "hypridle is running"
else
    log_warning "hypridle failed to start"
fi

echo ""
log_success "Hypridle & Hyprlock setup fix completed!"
echo ""
echo "ðŸ“‹ Next steps:"
echo "1. Test screen locking: Wait 10 minutes or run 'hyprlock' manually"
echo "2. Test suspend: Run 'systemctl suspend' or close laptop lid"
echo "3. If issues persist, run: $SCRIPT_DIR/debug-hypridle"
echo ""
echo "ðŸ”§ Configuration files:"
echo "  - hypridle: $HYPRIDLE_CONF"
echo "  - hyprlock: $HYPRLOCK_CONF"
echo "  - PAM: $PAM_CONF"
echo "  - logind: $LOGIND_CONF"
