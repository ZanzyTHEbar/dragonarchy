#!/bin/bash
set -euo pipefail

SCRIPT_DIR="$(cd -P "$(dirname "$0")" && pwd)"
PKG_THEMES_DIR="$SCRIPT_DIR/../../packages/sddm/usr/share/sddm/themes"
SYS_THEMES_DIR="/usr/share/sddm/themes"

# Ensure packaged themes are present as real files (no symlinks)
"$SCRIPT_DIR/refresh-sddm"

# Prefer listing from packaged repo (authoritative list)
LIST_DIR="$PKG_THEMES_DIR"
[[ -d "$LIST_DIR" ]] || LIST_DIR="$SYS_THEMES_DIR"

mapfile -t themes < <(find "$LIST_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | sort)

if [[ ${#themes[@]} -eq 0 ]]; then
    echo "No SDDM themes found in $THEMES_DIR" >&2
    exit 1
fi

display=()
for t in "${themes[@]}"; do
    display+=("$(echo "$t" | sed -E 's/(^|-)([a-z])/(\1\U\2)/g; s/-/ /g')")
done

choice=$(printf '%s\n' "${display[@]}" | gum choose --header="Select an SDDM theme")
sel=$(echo "$choice" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')

"$(dirname "$0")/sddm-set" "$sel"
