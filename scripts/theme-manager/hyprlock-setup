#!/usr/bin/env bash
# Ensure a minimal Hyprlock config exists and aligns with current theme

set -euo pipefail

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/hypr"
CONF_FILE="$CONF_DIR/hyprlock.conf"
LEGACY_CONF1="${XDG_CONFIG_HOME:-$HOME/.config}/hypr/config/hyprlock.conf"
ALT_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/hyprlock.conf"
PALETTE_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/current/theme/hyprland-palette.conf"
BG_LINK="${XDG_CONFIG_HOME:-$HOME/.config}/current/background"

mkdir -p "$CONF_DIR"

# If canonical config already exists, stop
if [[ -f "$CONF_FILE" || -L "$CONF_FILE" ]]; then
  exit 0
fi

# If user keeps config in legacy or alt locations, symlink to canonical and stop
if [[ -f "$LEGACY_CONF1" ]]; then
  ln -sf "$LEGACY_CONF1" "$CONF_FILE"
  echo "Hyprlock config linked: $CONF_FILE -> $LEGACY_CONF1"
  exit 0
fi
if [[ -f "$ALT_CONF" ]]; then
  ln -sf "$ALT_CONF" "$CONF_FILE"
  echo "Hyprlock config linked: $CONF_FILE -> $ALT_CONF"
  exit 0
fi

# Fallback colors
FG="rgba(0xe6edf3ff)"
ACC="rgba(0x79c0ffff)"
PANEL_BG="rgba(0x141a24cc)"
OUTLINE="rgba(0xffffff40)"

# Attempt to read palette variables if present
if [[ -f "$PALETTE_FILE" ]]; then
  get_rgba() { grep -E "^\$${1}\s*=\s*rgba\([^)]*\)" "$PALETTE_FILE" | sed -E 's/.*rgba\(([^)]*)\).*/rgba(\1)/' | tr -d ' \n' | head -n1; }
  FG_CAND=$(get_rgba foreground || true)
  ACC_CAND=$(get_rgba accent || true)
  [[ -n "${FG_CAND:-}" ]] && FG="$FG_CAND"
  [[ -n "${ACC_CAND:-}" ]] && ACC="$ACC_CAND"
fi

cat >"$CONF_FILE" <<EOF
# Generated by hyprlock-setup

general {
  grace = 0
}

background {
  monitor = 
  path = ${BG_LINK}
  blur_passes = 2
  blur_size = 8
  brightness = 0.85
}

label {
  monitor = 
  text = \$TIME
  font_family = Inter
  font_size = 48
  color = ${FG}
  position = 0, 120
  halign = center
  valign = top
}

input-field {
  monitor = 
  size = 420, 52
  position = 0, 0
  halign = center
  valign = center
  rounding = 12

  # Colors
  outer_color = ${OUTLINE}
  inner_color = ${PANEL_BG}
  font_color = ${FG}
  check_color = ${ACC}
  fail_color = rgba(0xff5555ff)

  # Behavior
  dots_center = true
  fade_on_empty = false
  placeholder_text = <i>Enter passwordâ€¦</i>
}
EOF

echo "Hyprlock config created at $CONF_FILE"
