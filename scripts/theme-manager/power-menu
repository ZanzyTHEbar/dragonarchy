#!/bin/bash
# Displays a power menu.

# Resolve script dir for calling helpers
SOURCE=${BASH_SOURCE[0]}
while [ -h "$SOURCE" ]; do
  DIR=$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)
  SOURCE=$(readlink "$SOURCE")
  [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE
done
SCRIPT_DIR=$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)

# Ensure hyprlock has a minimal config (prevents white screen on first run)
if command -v hyprlock >/dev/null 2>&1; then
  "$SCRIPT_DIR/hyprlock-setup" >/dev/null 2>&1 || true
fi

# If wlogout is present and not explicitly disabled, prefer it using stowed config
if command -v wlogout >/dev/null 2>&1 && [ -z "${DRAGON_TUI_ONLY:-}" ]; then
  exec wlogout
else
  show_power_menu() {
    local options=("Lock" "Logout" "Suspend" "Reboot" "Shutdown" "Cancel")
    local choice=$(printf "%s\n" "${options[@]}" | gum choose --header="Power Menu")

    case "$choice" in
    "Lock") hyprlock ;;
    "Logout") bash -lc 'loginctl terminate-session "$XDG_SESSION_ID" || loginctl terminate-user "$USER" || uwsm stop || hyprctl dispatch exit' ;;
    "Suspend") systemctl suspend ;;
    "Reboot") systemctl reboot ;;
    "Shutdown") systemctl poweroff ;;
    "Cancel") exit 0 ;;
    esac
  }

  show_power_menu
fi
