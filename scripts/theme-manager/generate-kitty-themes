#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
THEMES_DIR="$(cd "$SCRIPT_DIR/../../packages/themes/.config/themes" && pwd)"

hex6() { # input: 1a1b26ff (no rgba()) or rgba(1a1b26ff)
  local v="$1"
  v=${v#rgba(}
  v=${v%\)}  # escape the closing brace
  printf '#%s' "${v:0:6}"
}

blend_hex() { # blend two RGBA hex strings (no leading #) using percentage of second color
  local base="${1:0:6}"
  local mix="${2:0:6}"
  local weight="${3:-50}"
  local inv=$((100 - weight))
  local r=$(( ( (0x${base:0:2}) * inv + (0x${mix:0:2}) * weight + 50 ) / 100 ))
  local g=$(( ( (0x${base:2:2}) * inv + (0x${mix:2:2}) * weight + 50 ) / 100 ))
  local b=$(( ( (0x${base:4:2}) * inv + (0x${mix:4:2}) * weight + 50 ) / 100 ))
  printf '#%02x%02x%02x' "$r" "$g" "$b"
}

get_rgba() {
  # Extracts the rgba(...) token from palette lines like: $background = rgba(1a1b26ff)
  local file="$1" key="$2"
  awk -v k="$key" '$1==("$"k) {print $3}' "$file" | sed -E 's/rgba\(([^)]*)\)/\1/' | tr -d ' \n' | head -n1 || true
}

for theme in "$THEMES_DIR"/*/; do
  palette="$theme/hyprland-palette.conf"
  [ -f "$palette" ] || continue

  b=$(get_rgba "$palette" background)
  f=$(get_rgba "$palette" foreground)
  c=$(get_rgba "$palette" comment)
  a=$(get_rgba "$palette" accent)
  r=$(get_rgba "$palette" red)
  g=$(get_rgba "$palette" green)
  o=$(get_rgba "$palette" orange)
  y=$(get_rgba "$palette" yellow)
  bl=$(get_rgba "$palette" blue)
  m=$(get_rgba "$palette" magenta)
  cy=$(get_rgba "$palette" cyan)

  # Fallbacks if missing
  : "${y:=$o}"
  : "${bl:=$a}"
  : "${m:=$a}"
  : "${cy:=$a}"
  : "${c:=$f}"
  : "${a:=$f}"

  # Derive border colors: accent for active/bell, soft blend of background/comment for inactive
  inactive_border=$(blend_hex "$b" "${c:-$f}" 55)
  active_border=$(hex6 "$a")

  cat >"${theme%/}/kitty.conf" <<EOF
# Auto-generated from hyprland-palette.conf. Do not edit by hand.
# Generated by scripts/theme-manager/generate-kitty-themes

foreground $(hex6 "$f")
background $(hex6 "$b")
cursor $(hex6 "$a")
cursor_text_color $(hex6 "$b")
selection_background $(hex6 "$a")
selection_foreground $(hex6 "$b")
url_color $(hex6 "$a")

# Inline hints / autocomplete colors
shell_integration    enabled
shell               zsh
zsh_autosuggestion   $(hex6 "$a")
url_style            none

active_border_color $active_border
inactive_border_color $inactive_border
bell_border_color $active_border

color0  $(hex6 "$b")
color1  $(hex6 "$r")
color2  $(hex6 "$g")
color3  $(hex6 "$y")
color4  $(hex6 "$bl")
color5  $(hex6 "$m")
color6  $(hex6 "$cy")
color7  $(hex6 "$f")

color8  $(hex6 "$c")
color9  $(hex6 "$r")
color10 $(hex6 "$g")
color11 $(hex6 "$y")
color12 $(hex6 "$bl")
color13 $(hex6 "$m")
color14 $(hex6 "$cy")
color15 $(hex6 "$f")
EOF
  echo "Wrote ${theme}kitty.conf"
done
