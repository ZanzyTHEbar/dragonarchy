#!/usr/bin/env bash
# Debug script for hypridle and hyprlock issues

set -euo pipefail

echo "ðŸ” Hypridle & Hyprlock Debug Report"
echo "===================================="

# Check if services are running
echo ""
echo "ðŸ“Š Service Status:"
echo "hypridle running: $(pgrep -x hypridle >/dev/null && echo "âœ… YES" || echo "âŒ NO")"
echo "hyprlock running: $(pgrep -x hyprlock >/dev/null && echo "âœ… YES" || echo "âŒ NO")"

# Check configuration files
echo ""
echo "ðŸ“ Configuration Files:"
HYPRIDLE_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/hypr/config/hypridle.conf"
HYPRLOCK_CONF="${XDG_CONFIG_HOME:-$HOME/.config}/hypr/hyprlock.conf"

if [[ -f "$HYPRIDLE_CONF" ]]; then
    echo "âœ… hypridle.conf exists: $HYPRIDLE_CONF"
    echo "   Last modified: $(stat -c %y "$HYPRIDLE_CONF" 2>/dev/null || stat -f %Sm -t %Y-%m-%d_%H:%M:%S "$HYPRIDLE_CONF")"
else
    echo "âŒ hypridle.conf missing: $HYPRIDLE_CONF"
fi

if [[ -f "$HYPRLOCK_CONF" ]]; then
    echo "âœ… hyprlock.conf exists: $HYPRLOCK_CONF"
    echo "   Last modified: $(stat -c %y "$HYPRLOCK_CONF" 2>/dev/null || stat -f %Sm -t %Y-%m-%d_%H:%M:%S "$HYPRLOCK_CONF")"
else
    echo "âŒ hyprlock.conf missing: $HYPRLOCK_CONF"
fi

# Check PAM configuration
echo ""
echo "ðŸ” PAM Configuration:"
if [[ -f "/etc/pam.d/hyprlock" ]]; then
    echo "âœ… PAM config exists: /etc/pam.d/hyprlock"
    echo "   Contents:"
    cat /etc/pam.d/hyprlock | sed 's/^/   /'
else
    echo "âŒ PAM config missing: /etc/pam.d/hyprlock"
fi

# Check systemd services
echo ""
echo "âš™ï¸ Systemd Services:"
for service in "sleep.target" "suspend.target" "hibernate.target"; do
    if systemctl is-active "$service" >/dev/null 2>&1; then
        echo "âœ… $service: ACTIVE"
    else
        echo "âŒ $service: INACTIVE"
    fi
done

# Check logind configuration
echo ""
echo "ðŸ“‹ Logind Configuration:"
if [[ -f "/etc/systemd/logind.conf" ]]; then
    echo "âœ… logind.conf exists"
    grep -E "^(HandleLidSwitch|HandlePowerKey|IdleAction)=" /etc/systemd/logind.conf || echo "   No power management settings found"
else
    echo "âŒ logind.conf missing"
fi

# Test basic hyprlock functionality
echo ""
echo "ðŸ§ª Testing hyprlock (will timeout after 5 seconds):"
timeout 5s hyprlock --help >/dev/null 2>&1 && echo "âœ… hyprlock command works" || echo "âŒ hyprlock command failed"

# Check for common issues
echo ""
echo "ðŸ”§ Common Issues Check:"
if ! pgrep -x "gdm" >/dev/null 2>&1 && ! pgrep -x "sddm" >/dev/null 2>&1 && ! pgrep -x "lightdm" >/dev/null 2>&1; then
    echo "âš ï¸  No display manager detected - ensure you're running in a proper desktop session"
fi

if ! groups | grep -q "wheel\|sudo"; then
    echo "âš ï¸  User not in sudo group - may cause authentication issues"
fi

# Check environment variables
echo ""
echo "ðŸŒ Environment Variables:"
echo "XDG_SESSION_TYPE: ${XDG_SESSION_TYPE:-NOT_SET}"
echo "WAYLAND_DISPLAY: ${WAYLAND_DISPLAY:-NOT_SET}"
echo "HYPRLAND_INSTANCE_SIGNATURE: ${HYPRLAND_INSTANCE_SIGNATURE:-NOT_SET}"

echo ""
echo "ðŸ“ Recommendations:"
if [[ ! -f "$HYPRIDLE_CONF" ]]; then
    echo "- Create hypridle.conf configuration file"
fi
if [[ ! -f "/etc/pam.d/hyprlock" ]]; then
    echo "- Configure PAM for hyprlock authentication"
fi
if ! pgrep -x hypridle >/dev/null; then
    echo "- Start hypridle service"
fi

echo ""
echo "Debug report complete."
