#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
DOTFILES_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
# shellcheck disable=SC1091
source "$DOTFILES_ROOT/scripts/lib/notifications.sh"

if [[ $# -lt 1 ]]; then
  echo "Usage: theme-set-background <image-path>" >&2
  exit 1
fi

target="$1"

if [[ "$target" == "~/"* ]]; then
  target="${target/#\~/$HOME}"
fi

if [[ ! -f "$target" ]]; then
  echo "theme-set-background: file not found: $target" >&2
  exit 1
fi

STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/dragon/theme-manager"
mkdir -p "$STATE_DIR"
PREV_BG_FILE="$STATE_DIR/prev-background"

link="${XDG_CONFIG_HOME:-$HOME/.config}/current/background"
mkdir -p "$(dirname "$link")"

# Record previous background for undo
if [[ -L "$link" ]]; then
  prev="$(readlink -f "$link" 2>/dev/null || true)"
  [[ -n "$prev" ]] && printf '%s\n' "$prev" >"$PREV_BG_FILE"
fi

ln -nsf "$target" "$link"

# Restart swaybg to apply the new background
pkill -x swaybg >/dev/null 2>&1 || true
setsid uwsm app -- swaybg -i "$link" -m fill >/dev/null 2>&1 &

notify_send "Background Updated" "$(basename "$target")"


