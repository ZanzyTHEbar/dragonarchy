#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/theme-utils.sh
source "$SCRIPT_DIR/lib/theme-utils.sh"

WALKER_DEFAULT_STYLE="$DOTFILES_ROOT/vendored/walker/resources/themes/default/style.css"

if [[ ! -f "$WALKER_DEFAULT_STYLE" ]]; then
  echo "walker default style not found at $WALKER_DEFAULT_STYLE" >&2
  exit 1
fi

walker_base_css="$(awk '!/^[[:space:]]*@define-color[[:space:]]/' "$WALKER_DEFAULT_STYLE")"

for theme in "$THEMES_DIR"/*/; do
  palette="$theme/hyprland-palette.conf"
  [[ -f "$palette" ]] || continue

  if ! background="$(tm_palette_hex "$palette" background)"; then
    echo "Skipping $theme: missing background color" >&2
    continue
  fi

  if ! foreground="$(tm_palette_hex "$palette" foreground)"; then
    echo "Skipping $theme: missing foreground color" >&2
    continue
  fi

  accent="$(tm_palette_hex "$palette" accent "$foreground")"

  if ! error_bg="$(tm_palette_hex "$palette" red)"; then
    error_bg="$(tm_hex_blend "$accent" "$background" 40)"
  fi

  error_fg="$foreground"

  output_file="${theme%/}/walker.css"

  {
    printf '/* Auto-generated Walker theme - color overrides only */\n'
    printf '@define-color window_bg_color %s;\n' "$background"
    printf '@define-color accent_bg_color %s;\n' "$accent"
    printf '@define-color theme_fg_color %s;\n' "$foreground"
    printf '@define-color error_bg_color %s;\n' "$error_bg"
    printf '@define-color error_fg_color %s;\n\n' "$error_fg"
    printf '%s\n' "$walker_base_css"
  } >"$output_file"

  echo "Wrote ${theme}walker.css"
done