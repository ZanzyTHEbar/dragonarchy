#!/bin/bash

# Get the directory of the script, resolving symlinks
SOURCE=${BASH_SOURCE[0]}
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
    DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )
    SOURCE=$(readlink "$SOURCE")
    [[ $SOURCE != /* ]] && SOURCE=$DIR/$SOURCE # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPT_DIR=$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )

PATH="$PATH:$SCRIPT_DIR/theme-manager"

# Function definitions
ack_command() {
    gum spin --spinner "globe" --title "Done!" -- sleep 1
}

ensure_tty() {
    if [[ ! -t 0 || ! -t 1 ]]; then
        echo "dragon-cli interactive menus require a TTY. Run this command inside a terminal or use direct subcommands such as theme-set." >&2
        return 1
    fi
    return 0
}

show_theme_summary() {
    local theme_path background_path theme_name background_name
    theme_path=$(readlink -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/theme" 2>/dev/null || true)
    background_path=$(readlink -f "${XDG_CONFIG_HOME:-$HOME/.config}/current/background" 2>/dev/null || true)
    theme_name="${theme_path:+$(basename "$theme_path")}"
    background_name="${background_path:+$(basename "$background_path")}"

    theme_name="${theme_name:-unknown}"
    background_name="${background_name:-unknown}"

    if [[ -t 1 ]] && command -v gum >/dev/null 2>&1; then
        gum style --foreground 6 --bold "Theme Applied"
        gum style --foreground 2 "Theme: $theme_name"
        gum style --foreground 4 "Background: $background_name"
    else
        printf 'Theme Applied -> theme: %s | background: %s\n' "$theme_name" "$background_name"
    fi
}

nfs_menu() {
    gum style --foreground 6 --bold "NFS Configuration"
    echo ""
    gum style --foreground 8 "Configure NFS mounts with systemd automount"
    echo ""
    
    local nfs_host
    nfs_host=$(gum input --placeholder="NFS server host (e.g., 192.168.1.100 or dragonserver.local)" --header="")
    [[ -z "$nfs_host" ]] && return
    
    local nfs_base
    nfs_base=$(gum input --placeholder="NFS server base path (e.g., /mnt/nfs or mainpool/nfsroot)" --header="")
    [[ -z "$nfs_base" ]] && return
    
    local datasets
    datasets=$(gum input --placeholder="Dataset(s) separated by spaces (e.g., data common or data:dragonnet)" --header="")
    [[ -z "$datasets" ]] && return
    
    echo ""
    gum style --foreground 2 "Configuration:"
    echo "  Host: $nfs_host"
    echo "  Base: $nfs_base"
    echo "  Datasets: $datasets"
    echo ""
    
    if gum confirm "Proceed with NFS configuration? (requires sudo)"; then
        # shellcheck disable=SC2086  # We want word splitting for datasets
        "$SCRIPT_DIR/utilities/nfs.sh" "$nfs_host" "$nfs_base" $datasets
        ack_command
    fi
}

create_web_app() {
    gum style --foreground 6 --bold "Create Web Application Launcher"
    echo ""
    
    local app_name
    app_name=$(gum input --placeholder="Application name (e.g., GitHub)" --header="")
    [[ -z "$app_name" ]] && return
    
    local app_url
    app_url=$(gum input --placeholder="Application URL (e.g., https://github.com)" --header="")
    [[ -z "$app_url" ]] && return
    
    local icon_url
    icon_url=$(gum input --placeholder="Icon URL (e.g., https://github.com/favicon.ico)" --header="")
    [[ -z "$icon_url" ]] && return
    
    echo ""
    gum style --foreground 2 "Web App Configuration:"
    echo "  Name: $app_name"
    echo "  URL: $app_url"
    echo "  Icon: $icon_url"
    echo ""
    
    if gum confirm "Create web app launcher?"; then
        source "$SCRIPT_DIR/utilities/web-apps.sh"
        web2app "$app_name" "$app_url" "$icon_url"
    fi
}

web_apps_menu() {
    local options=("Create Web App" "Back")
    choice=$(printf "%s\n" "${options[@]}" | gum choose --header="Web Apps") || return
    
    case "$choice" in
        "Create Web App")
            create_web_app
            ack_command
        ;;
        Back) return ;;
    esac
}

secrets_menu() {
    local options=(
        "Setup - Initial secrets management setup"
        "Create - Create encrypted secrets from input"
        "Install - Install all secrets to machine"
        "Install SSH Keys - Install SSH private keys"
        "Install API Keys - Install API keys/env vars"
        "Edit - Edit encrypted secrets file"
        "Decrypt - View decrypted secrets"
        "Verify - Verify secrets can be decrypted"
        "Generate Key - Generate new age encryption key"
        "Backup - Backup secrets and keys"
        "Back"
    )
    
    choice=$(printf "%s\n" "${options[@]}" | gum choose --header="Secrets Management") || return
    
    case "$choice" in
        "Setup"*) 
            "$SCRIPT_DIR/utilities/secrets.sh" setup
            ack_command
        ;;
        "Create - Create"*)
            "$SCRIPT_DIR/utilities/secrets.sh" create
            ack_command
        ;;
        "Install - Install"*)
            "$SCRIPT_DIR/utilities/secrets.sh" install
            ack_command
        ;;
        "Install SSH"*)
            "$SCRIPT_DIR/utilities/secrets.sh" install-keys
            ack_command
        ;;
        "Install API"*)
            "$SCRIPT_DIR/utilities/secrets.sh" install-api
            ack_command
        ;;
        "Edit"*)
            "$SCRIPT_DIR/utilities/secrets.sh" edit
            ack_command
        ;;
        "Decrypt"*)
            "$SCRIPT_DIR/utilities/secrets.sh" decrypt
            ack_command
        ;;
        "Verify"*)
            "$SCRIPT_DIR/utilities/secrets.sh" verify
            ack_command
        ;;
        "Generate"*)
            "$SCRIPT_DIR/utilities/secrets.sh" generate-key
            ack_command
        ;;
        "Backup"*)
            "$SCRIPT_DIR/utilities/secrets.sh" backup
            ack_command
        ;;
        Back) return ;;
    esac
}

utilities_menu() {
    ensure_tty || return
    local options=("NFS" "Web Apps" "Docker DBs" "Secrets" "Add Migration" "Deps Manifest" "Netbird" "Back")
    choice=$(printf "%s\n" "${options[@]}" | gum choose --header="Utilities") || main_menu
    case "$choice" in
        NFS)
            nfs_menu
            utilities_menu
        ;;
        "Web Apps")
            web_apps_menu
            utilities_menu
        ;;
        "Docker DBs")
            "$SCRIPT_DIR/utilities/docker-dbs.sh"
            ack_command
            utilities_menu
        ;;
        Secrets)
            secrets_menu
            utilities_menu
        ;;
        "Add Migration")
            "$SCRIPT_DIR/utilities/add-migration.sh"
            ack_command
            utilities_menu
        ;;
        "Deps Manifest")
            "$SCRIPT_DIR/utilities/deps-manifest.sh"
            ack_command
            utilities_menu
        ;;
        Netbird)
            "$SCRIPT_DIR/utilities/netbird-install.sh"
            ack_command
            utilities_menu
        ;;
        Back) main_menu ;;
    esac
}

install_theme_prompt() {
    local url
    url=$(gum input --placeholder="Git repo URL for theme" --header="")
    if [[ -n "$url" ]]; then
        theme-install "$url"
    fi
}

remove_theme_prompt() {
    local theme
    theme=$(gum input --placeholder="Theme name" --header="")
    if [[ -n "$theme" ]]; then
        theme-remove "$theme"
    fi
}

list_sddm_themes() {
    local sys_themes_dir="/usr/share/sddm/themes"
    local pkg_themes_dir="$SCRIPT_DIR/../packages/sddm/usr/share/sddm/themes"
    local current_theme=""
    
    # Get current theme from config
    if [[ -f /etc/sddm.conf.d/10-theme.conf ]]; then
        current_theme=$(grep -E '^\s*Current\s*=' /etc/sddm.conf.d/10-theme.conf | sed -E 's/^\s*Current\s*=\s*//' | tr -d '[:space:]')
    fi
    
    echo ""
    gum style --bold --foreground 6 "SDDM Themes"
    echo ""
    
    # Show available themes from dotfiles
    if [[ -d "$pkg_themes_dir" ]]; then
        gum style --foreground 2 --bold "Available in Dotfiles:"
        while IFS= read -r theme; do
            echo "Theme: $theme"
            # Get the theme name from the directory path

            local theme_name
            theme_name=$(basename "$theme")
            
            if [[ -d "$sys_themes_dir/$theme_name" ]]; then
                if [[ "$theme_name" == "$current_theme" ]]; then
                    echo "  ✓ $theme_name (active, installed)"
                else
                    echo "  ✓ $theme_name (installed)"
                fi
            else
                echo "  ○ $theme_name (not installed)"
            fi
        done < <(find "$pkg_themes_dir" -mindepth 1 -maxdepth 1 -type d | sort)
        echo ""
    fi
    
    # Show currently active theme
    if [[ -n "$current_theme" ]]; then
        gum style --foreground 3 --bold "Current Active Theme:"
        echo "  → $current_theme"
    else
        gum style --foreground 1 "No theme configured (using SDDM default)"
    fi
    
    echo ""
    gum style --foreground 8 "Tip: Use 'Select Theme' to change, 'Refresh/Update' to install from dotfiles"
    echo ""
    gum confirm "Return to menu?" || exit 0
}

sddm_theme_menu() {
    ensure_tty || return
    # Check if SDDM is installed
    if ! command -v sddm >/dev/null 2>&1; then
        gum style --foreground 3 --border normal --padding "0 1" --margin "1 0" \
        "SDDM is not installed on this system." \
        "Install SDDM to manage themes."
        gum confirm "Return to menu?" && theme_menu || exit 0
        return
    fi
    
    local options=("List Themes" "Select Theme" "Refresh/Update Themes" "Verify Setup" "Back")
    choice=$(printf "%s\n" "${options[@]}" | gum choose --header="SDDM Themes") || theme_menu
    
    case "$choice" in
        "List Themes")
            list_sddm_themes
            sddm_theme_menu
        ;;
        "Select Theme")
            if [[ -x "$SCRIPT_DIR/theme-manager/sddm-menu" ]]; then
                "$SCRIPT_DIR/theme-manager/sddm-menu"
                ack_command
            else
                gum style --foreground 1 "sddm-menu script not found"
                sleep 2
            fi
            sddm_theme_menu
        ;;
        "Refresh/Update Themes")
            if [[ -x "$SCRIPT_DIR/theme-manager/refresh-sddm" ]]; then
                gum confirm "Refresh SDDM themes from dotfiles? (requires sudo)" && {
                    "$SCRIPT_DIR/theme-manager/refresh-sddm"
                    ack_command
                }
            else
                gum style --foreground 1 "refresh-sddm script not found"
                sleep 2
            fi
            sddm_theme_menu
        ;;
        "Verify Setup")
            if [[ -x "$SCRIPT_DIR/utilities/verify-sddm-setup.sh" ]]; then
                "$SCRIPT_DIR/utilities/verify-sddm-setup.sh"
                echo ""
                gum confirm "Return to menu?"
            else
                gum style --foreground 1 "verify-sddm-setup.sh script not found"
                sleep 2
            fi
            sddm_theme_menu
        ;;
        Back) theme_menu ;;
    esac
}

theme_menu() {
    ensure_tty || return
    local options=("Pick" "Install" "Update" "Remove" "Change Background" "Next Background" "SDDM Themes" "Back")
    choice=$(printf "%s\n" "${options[@]}" | gum choose --header="Theme") || main_menu
    case "$choice" in
        Pick)
            if "$SCRIPT_DIR/theme-manager/theme-menu"; then
                ack_command
                show_theme_summary
            fi
            main_menu
        ;;
        Install)
            install_theme_prompt
            ack_command
            show_theme_summary
            theme_menu
        ;;
        Update)
            if theme-update; then
                ack_command
                show_theme_summary
            fi
            theme_menu
        ;;
        Remove)
            remove_theme_prompt
            ack_command
            theme_menu
        ;;
        "Change Background")
            if theme-bg-menu; then
                ack_command
                show_theme_summary
            fi
            theme_menu
        ;;
        "Next Background")
            if "$SCRIPT_DIR/theme-manager/theme-bg-next"; then
                ack_command
                show_theme_summary
            else
                sleep 1
            fi
            theme_menu
        ;;
        "SDDM Themes")
            sddm_theme_menu
        ;;
        Back) main_menu ;;
    esac
}

main_menu() {
    ensure_tty || exit 2
    local options=("Theme" "Cursors" "Utilities" "Update" "Setup" "Power Menu" "Keybindings" "Font Menu" "Exit")
    choice=$(printf "%s\n" "${options[@]}" | gum choose --header="") || exit 0
    case "$choice" in
        Theme) theme_menu ;;
        Cursors)
            "$SCRIPT_DIR/theme-manager/cursors/cursor-menu"
            main_menu
        ;;
        Utilities) utilities_menu ;;
        Update)
            "$SCRIPT_DIR/install/update.sh"
            ack_command
            main_menu
        ;;
        Setup)
            "$SCRIPT_DIR/../setup.sh"
            ack_command
            main_menu
        ;;
        "Power Menu")
            power-menu
            main_menu
        ;;
        "Keybindings")
            keybindings-menu
            main_menu
        ;;
        "Font Menu")
            font-menu
            main_menu
        ;;
        Exit) clear && exit 0 ;;
    esac
}

# Handle direct command arguments
case "${1:-}" in
    theme)
        shift
        theme_menu
        exit 0
    ;;
    background)
        shift
        theme-bg-menu
        exit 0
    ;;
    cursor|cursors)
        shift
        "$SCRIPT_DIR/theme-manager/cursors/cursor-menu"
        exit 0
    ;;
    keybindings)
        shift
        keybindings-menu
        exit 0
    ;;
    power)
        shift
        power-menu
        exit 0
    ;;
    font|fonts)
        shift
        font-menu
        exit 0
    ;;
    sddm)
        shift
        sddm_theme_menu
        exit 0
    ;;
    utilities)
        shift
        case "${1:-}" in
            nfs)
                shift
                nfs_menu
                exit 0
            ;;
            web-apps)
                shift
                web_apps_menu
                exit 0
            ;;
            docker-dbs)
                shift
                "$SCRIPT_DIR/utilities/docker-dbs.sh"
                exit 0
            ;;
            secrets)
                shift
                secrets_menu
                exit 0
            ;;
            add-migration)
                shift
                "$SCRIPT_DIR/utilities/add-migration.sh"
                exit 0
            ;;
            deps-manifest|deps)
                shift
                "$SCRIPT_DIR/utilities/deps-manifest.sh" "$@"
                exit 0
            ;;
            netbird)
                shift
                "$SCRIPT_DIR/utilities/netbird-install.sh"
                exit 0
            ;;
            *)
                utilities_menu
                exit 0
            ;;
        esac
    ;;
esac

main_menu
