#!/usr/bin/env bash
# Enhanced clipse wrapper with theme-aware styling and advanced features

set -euo pipefail

# Configuration
CLIPSE_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/clipse"
CLIPSE_THEME="$CLIPSE_CONFIG/theme.toml"
TEMP_EDIT_FILE="/tmp/clipse_edit_$$"

# Enhanced clipse with fuzzy search
clipse_fuzzy() {
  local mode="${1:-normal}"
  
  case "$mode" in
    search)
      # Use fzf for advanced fuzzy search (if clipse --list-history works)
      if clipse -p &>/dev/null; then
        # Clipse is working, but list-history might not exist
        # Fall back to regular clipse TUI
        exec clipse
      else
        echo "Error: clipse daemon not running" >&2
        echo "Start with: clipse -listen &" >&2
        read -p "Press Enter to exit..."
        exit 1
      fi
      ;;
    *)
      # Normal mode - just run clipse TUI
      # Check if daemon is running
      if ! pgrep -x clipse >/dev/null; then
        echo "⚠️  Clipse daemon not running!" >&2
        echo ""
        echo "Starting clipse daemon..." >&2
        clipse -listen &
        sleep 0.5
      fi
      
      # Run clipse TUI
      exec clipse
      ;;
  esac
}

# Main execution
main() {
  local mode="${1:-normal}"
  
  # Check if clipse is installed
  if ! command -v clipse &>/dev/null; then
    echo "Error: clipse is not installed" >&2
    echo "Install with: yay -S clipse-bin" >&2
    read -p "Press Enter to exit..."
    exit 1
  fi
  
  # Launch clipse with the specified mode
  clipse_fuzzy "$mode"
}

# Run if executed directly
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  main "$@"
fi
