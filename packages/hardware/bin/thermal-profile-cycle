#!/usr/bin/env bash
set -euo pipefail

# Cycle thermal profiles: quiet -> balanced -> cool -> max -> quiet
# Applies fan & pump curves via liquidctl if available; otherwise adjusts power profile via powerprofilesctl.

STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/waybar_thermals_profile"
AIO_MATCH="${AIO_DEVICE:-h100i}"

current="quiet"
if [[ -f "$STATE_FILE" ]]; then
  current=$(<"$STATE_FILE")
fi

next="balanced"
case "$current" in
  quiet)     next="balanced" ;;
  balanced)  next="cool" ;;
  cool)      next="max" ;;
  max)       next="quiet" ;;
  # Migrate old states
  default)   next="balanced" ;;
  medium)    next="cool" ;;
  *)         next="quiet" ;;
esac

apply_liquidctl_profile() {
  local profile="$1"
  # Try to operate on the matched AIO device; ignore errors if device not present.
  case "$profile" in
    quiet)
      # Minimal noise: slower ramp; pump modest
      liquidctl --match "$AIO_MATCH" set fan speed \
        30 15 \
        40 20 \
        50 30 \
        60 45 \
        70 65 >/dev/null 2>&1 || true
      liquidctl --match "$AIO_MATCH" set pump speed 45 >/dev/null 2>&1 || true
      ;;
    balanced)
      # General use: moderate ramp; pump moderate
      liquidctl --match "$AIO_MATCH" set fan speed \
        30 20 \
        40 30 \
        50 45 \
        60 70 \
        70 100 >/dev/null 2>&1 || true
      liquidctl --match "$AIO_MATCH" set pump speed 65 >/dev/null 2>&1 || true
      ;;
    cool)
      # Sustained load: aggressive ramp to target ~70–75°C; pump high
      liquidctl --match "$AIO_MATCH" set fan speed \
        30 25 \
        40 40 \
        50 60 \
        60 85 \
        70 100 >/dev/null 2>&1 || true
      liquidctl --match "$AIO_MATCH" set pump speed 85 >/dev/null 2>&1 || true
      ;;
    max)
      # Maximum cooling and noise
      liquidctl --match "$AIO_MATCH" set fan speed 100 >/dev/null 2>&1 || true
      liquidctl --match "$AIO_MATCH" set pump speed 100 >/dev/null 2>&1 || true
      ;;
  esac
}

apply_power_profile() {
  local profile="$1"
  command -v powerprofilesctl >/dev/null 2>&1 || return 0
  case "$profile" in
    quiet)    powerprofilesctl set power-saver >/dev/null 2>&1 || powerprofilesctl set balanced >/dev/null 2>&1 || true ;;
    balanced) powerprofilesctl set balanced    >/dev/null 2>&1 || true ;;
    cool)     powerprofilesctl set performance >/dev/null 2>&1 || true ;;
    max)      powerprofilesctl set performance >/dev/null 2>&1 || true ;;
  esac
}

# Try liquidctl first if present
if command -v liquidctl >/dev/null 2>&1; then
  apply_liquidctl_profile "$next"
else
  apply_power_profile "$next"
fi

printf '%s' "$next" >"$STATE_FILE"

# Nudge Waybar custom module to refresh immediately if signal configured
pkill -RTMIN+11 waybar 2>/dev/null || true

exit 0


