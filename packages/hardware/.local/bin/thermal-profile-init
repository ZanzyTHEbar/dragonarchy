#!/usr/bin/env bash
set -euo pipefail

# Initialize thermal profile to quiet on login
# This prevents fans from blowing at max until user manually adjusts profile

STATE_FILE="${XDG_RUNTIME_DIR:-/tmp}/waybar_thermals_profile"
AIO_MATCH="${AIO_DEVICE:-h100i}"
PROFILE="quiet"

apply_liquidctl_profile() {
  local profile="$1"
  case "$profile" in
    quiet)
      # Minimal noise: slower ramp; pump modest
      liquidctl --match "$AIO_MATCH" set fan speed \
        30 15 \
        40 20 \
        50 30 \
        60 45 \
        70 65 >/dev/null 2>&1 || true
      liquidctl --match "$AIO_MATCH" set pump speed 45 >/dev/null 2>&1 || true
      ;;
  esac
}

apply_power_profile() {
  local profile="$1"
  command -v powerprofilesctl >/dev/null 2>&1 || return 0
  case "$profile" in
    quiet) powerprofilesctl set power-saver >/dev/null 2>&1 || powerprofilesctl set balanced >/dev/null 2>&1 || true ;;
  esac
}

# Apply quiet profile
if command -v liquidctl >/dev/null 2>&1; then
  apply_liquidctl_profile "$PROFILE"
else
  apply_power_profile "$PROFILE"
fi

# Set state file so waybar shows correct profile
printf '%s' "$PROFILE" >"$STATE_FILE"

# Nudge Waybar to refresh if it's already running
pkill -RTMIN+11 waybar 2>/dev/null || true

exit 0

